<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ff8fb2" />
  <title>MafiaCats – Game (Data‑driven v0.91 – met inline uitleg)</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /*
      UI‑kleuren en basisstijl
      ------------------------------------------------------------
      - We houden alles licht en roze‑tinten voor de "schattige mafia" vibe.
      - Panelen hebben subtiele borders en schaduwen.
    */
    :root{ --accent:#ff8fb2; --accent-600:#ff6f9c; --lav:#cdb4f5; }
    body{ background:#fff6f8; font-family:'Outfit',sans-serif; color:#2e2a2c; }
    .panel{ background:#fff; border:1px solid #f4d4e0; border-radius:1rem; box-shadow:0 4px 16px rgba(0,0,0,.05); }
    .btn{ font-weight:600; transition:.15s; }
    .btn:hover{ transform:translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,.1); }
    .bar{ height:8px; border-radius:999px; background:#ffe1ec; overflow:hidden }
    .bar>i{ display:block; height:100%; background:linear-gradient(90deg, var(--accent), var(--lav)); }
    .xbar{ height:6px; border-radius:999px; background:#f7e7ef; overflow:hidden }
    .xbar>i{ display:block; height:100%; background:linear-gradient(90deg, #ffc1d6, #cdb4f5); }
    .tag{ font-size:.72rem; padding:.25rem .55rem; border-radius:.7rem; background:#ffe3ef; border:1px solid #ffcfe2; color:#7d2a4b; }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
    .pill{ font-size:.72rem; padding:.1rem .5rem; border-radius:.7rem; background:#ffe7f0; border:1px solid #ffd4e6; color:#7d2a4b; }
/* Politiekat-stempel: groter + trager */
@keyframes stamp {
  0%   { transform: scale(2.4); opacity: 0; }   /* start héél groot en fade in */
  22%  { transform: scale(1.15); opacity: 1; }  /* overshoot */
  38%  { transform: scale(1.00); opacity: 1; }  /* landt op 1x */
  80%  { transform: scale(0.45); opacity: .85;} /* krimpt duidelijk */
  100% { transform: scale(0.45); opacity: 0; }  /* fade out */
}
.stamp-anim {
  animation: stamp 1.4s ease-out forwards;      /* was 0.8s → nu 1.4s */
}
</style>
</head>
<body class="min-h-screen flex flex-col">
  <!--
    HEADER
    ------------------------------------------------------------
    - Toont snel HUD‑statistieken (cash/hp/energie/alert/rep) en acties: opslaan & resetten.
    - gearHUD laat actieve uitrusting zien, ook op mobiel.
  -->
  <header class="px-4 py-2 bg-white/85 backdrop-blur border-b border-pink-200 flex items-center justify-between">
    <a href="#" class="flex items-center gap-2 font-extrabold text-lg">🐾 Mafia<span class="text-pink-500">Cats</span></a>
    <div class="flex items-center gap-3 text-sm">
      <span class="hidden md:flex items-center gap-3">
        <span title="Blikvoer">🥫 <b id="hudCash">10</b></span>
        <span title="Levens">💖 <b id="hudHP">9</b></span>
        <span title="Energie">💤 <b id="hudEN">100%</b></span>
        <span title="Honden-alert">🐶 <b id="hudHeat">0%</b></span>
        <span title="Purr-points">✨ <b id="hudRep">0</b></span>
      </span>
      <div id="gearHUD" class="flex items-center gap-1 text-xs"></div>
      <button id="saveBtn" class="btn px-3 py-1.5 rounded-lg bg-black/5 hover:bg-black/10">Opslaan</button>
      <button id="resetBtn" class="btn px-3 py-1.5 rounded-lg bg-pink-200 hover:bg-pink-300">Reset</button>
    </div>
  </header>

  <!--
    LAYOUT
    ------------------------------------------------------------
    Drie kolommen:
      - Links: profiel + categorieknoppen (altijd zichtbaar zonder veel scroll)
      - Midden: "centerPanel" wisselt tussen schermen (log, lists, shop, inv, asiel, info)
      - Rechts: tips (optioneel)
    Het main heeft vaste hoogte (100vh - header) en gebruikt overflow-auto op het middenpaneel.
  -->
  <main class="flex-1 max-w-7xl mx-auto w-full p-3 md:p-4 grid lg:grid-cols-[320px_1fr_320px] gap-3 md:gap-4 overflow-hidden" style="height:calc(100vh - 56px)">
    <!-- LEFT: Profiel & categorieën -->
    <aside class="flex flex-col gap-3 md:gap-4 overflow-hidden">
      <!-- PROFIEL: toont kernstats, dagknoppen en toegang tot inventaris -->
      <section class="panel p-4 sticky top-3">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-full bg-pink-200 flex items-center justify-center text-2xl">🐱</div>
          <div class="grow">
            <input id="charName" class="w-full bg-pink-50/50 border border-pink-200 rounded-lg px-2 py-1 text-sm" placeholder="Jouw kattennaam"/>
            <p class="text-xs text-black/60 mt-1">Rang: <span id="rank">Kittenspion</span> · Dag <span id="day">1</span></p>
          </div>
        </div>
        <div class="mt-3 space-y-2 text-xs">
          <div>💤 Energie <span class="float-right" id="en">100%</span></div>
          <div class="bar"><i id="enBar" style="width:100%"></i></div>
          <div>🐶 Alert <span class="float-right" id="heat">0%</span></div>
          <div class="bar"><i id="heatBar" style="width:0%"></i></div>
          <div class="grid grid-cols-3 gap-2 text-center mt-2">
            <div class="panel p-2"><div class="text-lg" id="cash">10</div><div class="text-[10px] text-black/60">🥫 Blikvoer</div></div>
            <div class="panel p-2"><div class="text-lg" id="hp">9</div><div class="text-[10px] text-black/60">💖 Levens</div></div>
            <div class="panel p-2"><div class="text-lg" id="rep">0</div><div class="text-[10px] text-black/60">✨ Purr</div></div>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
            <button id="nextDay" class="btn px-3 py-2 rounded-lg bg-pink-500 text-white">Volgende dag</button>
            <button id="restBtn" class="btn px-3 py-2 rounded-lg bg-black/5 hover:bg-black/10">Rust</button>
          </div>
          <div class="mt-3">
            <button id="openInv" class="btn w-full px-4 py-3 rounded-xl bg-black/5 hover:bg-black/10">Inventaris</button>
          </div>
        </div>
      </section>

      <!-- CATEGORIE: Misdaden -->
      <section class="panel p-4">
        <h2 class="font-semibold mb-2">Misdaden</h2>
        <div class="grid grid-cols-1 gap-2">
          <!-- Overvallen zijn de "grote" misdaden met zwaardere risico's en gear‑impact -->
          <button id="openHeists" class="btn w-full px-4 py-3 rounded-xl bg-[var(--accent)] hover:bg-[var(--accent-600)] text-white">Overvallen</button>
          <!-- Kleinere misdaden (crime) delen dezelfde engine maar vaak lagere kosten/beloningen -->
          <button id="openCrimes" class="btn w-full px-4 py-3 rounded-xl bg-black/5 hover:bg-black/10">Misdaden</button>
        </div>
      </section>

      <!-- CATEGORIE: Algemeen (geen misdaad) -->
      <section class="panel p-4">
        <h2 class="font-semibold mb-2">Algemeen</h2>
        <div class="grid grid-cols-1 gap-2">
          <button id="openWork" class="btn w-full px-4 py-3 rounded-xl bg-black/5 hover:bg-black/10">Werk</button>
          <button id="openShop" class="btn w-full px-4 py-3 rounded-xl bg-black/5 hover:bg-black/10">Kattenshop</button>
          <button id="openAsiel" class="btn w-full px-4 py-3 rounded-xl bg-black/5 hover:bg-black/10">Kattenasiel</button>
          <button id="openInfo" class="btn w-full px-4 py-3 rounded-xl bg-black/5 hover:bg-black/10">Info</button>
        </div>
      </section>
    </aside>

    <!-- MIDDEN: views die in het centerPanel wisselen -->
    <section id="centerPanel" class="panel p-3 md:p-4 overflow-auto">
      <div class="flex items-center justify-between mb-2">
        <h2 id="centerTitle" class="text-lg font-extrabold">Stad & Logboek</h2>
        <div class="text-xs"><span id="centerTag" class="tag">v0.91</span></div>
      </div>

      <!-- Inline feedback/resultaatmelding (verdwijnt automatisch) -->
      <div id="centerResult" class="hidden mb-3 p-3 rounded-xl border text-sm"></div>

      <!-- LOG: standaard startscherm, prepend toont nieuwste bovenaan -->
      <div id="logView"><div id="log" class="space-y-1 text-sm"></div></div>

      <!-- GENERIC LIST VIEW: gebruikt door heists/crimes/werk om 1 renderer te delen -->
      <div id="listView" class="hidden">
        <p id="listIntro" class="text-sm text-black/70 mb-3"></p>
        <ul id="listUL" class="space-y-2 text-sm"></ul>
        <div class="mt-4">
          <button data-nav="log" class="btn px-4 py-2 rounded-lg bg-black/5 hover:bg-black/10">← Terug naar Logboek</button>
        </div>
      </div>

      <!-- SHOP: items kopen (gear), zie GEAR_CATALOG -->
      <div id="shopView" class="hidden">
        <p class="text-sm text-black/70 mb-3">Koop <b>uitrusting</b> met <b>uses</b>. Je kunt <b>max 2</b> items tegelijk uitrusten. Na elke overval/misdaad slijt 1 use.</p>
        <ul id="shopListCenter" class="text-sm space-y-2"></ul>
        <div class="mt-4"><button data-nav="log" class="btn px-4 py-2 rounded-lg bg-black/5 hover:bg-black/10">← Terug</button></div>
      </div>

      <!-- INVENTARIS: items equippen/unequippen -->
      <div id="invView" class="hidden">
        <p class="text-sm text-black/70 mb-3">Uitrusten en beheren. <b>Max 2</b> items tegelijk actief.</p>
        <div class="mb-2">Actief: <span id="activeGearBadges" class="inline-flex flex-wrap gap-1 align-middle"></span></div>
        <ul id="invListCenter" class="text-sm space-y-2"></ul>
        <div class="mt-4"><button data-nav="log" class="btn px-4 py-2 rounded-lg bg-black/5 hover:bg-black/10">← Terug</button></div>
      </div>

      <!-- ASIEL (tijdstraf) -->
      <div id="asielView" class="hidden">
        <div id="asielCard" class="p-4 border border-pink-200 rounded-xl bg-pink-50">
          <h3 class="font-semibold mb-1">Kattenasiel 🐾</h3>
          <p id="asielStatus" class="text-sm text-black/70 mb-2"></p>
          <div class="mono text-sm"><span id="asielCountdown">--:--:--</span></div>
        </div>
        <div class="mt-4"><button data-nav="log" class="btn px-4 py-2 rounded-lg bg-black/5 hover:bg-black/10">← Terug</button></div>
      </div>

      <!-- INFO + README: hoe nieuwe acties toe te voegen -->
      <div id="infoView" class="hidden">
        <h3 class="font-semibold mb-2">Info & speluitleg</h3>
        <div class="panel p-3 text-sm space-y-3">
          <p>Deze build gebruikt <b>data‑driven acties</b>. Nieuwe content toevoegen = regels in het <code>ACTIONS</code>-object.</p>
          <div class="panel p-3">
            <h4 class="font-semibold mb-1">README – zo voeg je acties toe</h4>
            <ol class="list-decimal ml-5 space-y-1 text-black/80">
              <li>Zoek <code>const ACTIONS = {...}</code>.</li>
              <li>Voeg een object toe aan <code>overvallen</code>, <code>misdaden</code> of <code>werk</code>.</li>
              <li>Velden: <code>key,type,name,emoji,base,cost,payout,rep,heatS,heatF,hpF,arrest,minutes,allowGear</code>.</li>
              <li>Sla op → refresh → klaar.</li>
            </ol>
          </div>
        </div>
        <div class="mt-3"><button data-nav="log" class="btn px-4 py-2 rounded-lg bg-black/5 hover:bg-black/10">← Terug</button></div>
      </div>
    </section>

    <!-- RECHTS: Tips (optioneel gameplay‑advies) -->
    <aside class="flex flex-col gap-3 md:gap-4 overflow-hidden">
      <section class="panel p-4">
        <h3 class="font-semibold mb-1">Tips</h3>
        <ul class="text-sm space-y-1 text-black/70">
          <li>📥 Nieuwe acties? Voeg regels toe aan <span class="pill">ACTIONS</span>.</li>
          <li>🧰 Uitrusting stapelt optelsgewijs (max 2 actief).</li>
          <li>🚨 100% Alert = 15 min Kattenasiel.</li>
        </ul>
      </section>
    </aside>
  </main>

  <script>
    /* ============================================================
       HULPFUNCTIES & STATE
       - We gebruiken een simpele PRNG (lineaire congruentie) voor deterministische RNG per sessie.
       - Alles wordt opgeslagen in localStorage (SAVE_KEY) zodat je voortgang bewaart tussen sessies.
    ============================================================ */

    // Korte query helpers
    const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

    // Versie van de save. Als je breaking changes doet, pas de key aan.
    const SAVE_KEY='mafiacats_data_v091';

    // Simpele "klik‑slot" om dubbele acties/spam te voorkomen.
    let actionLock=false; function withLock(fn){ if(actionLock) return; actionLock=true; try{ fn(); } finally{ setTimeout(()=>actionLock=false, 600); } }

    // Globale speltoestand. Als er geen save is, starten we met defaults.
    const state = load() || {
      name:'',cash:10,hp:9,en:100,rep:0,heat:0,day:1,
      xp:{},                 // XP per actiekey (bijv. xp['visboer'] = 12)
      gear:{ bag:[], equipped:[] }, // bag = items, equipped = indices naar bag
      seed:Math.floor(Math.random()*1e9), // startseed voor RNG
      asielUntil:0          // timestamp (ms) wanneer asiel eindigt; 0 = vrij
    };

    /*
      Catalogi: gear & acties
      ------------------------------------------------------------
      - GEAR_CATALOG beschrijft elk item (bonus, uses, prijs).
      - ACTIONS groepeert alle acties per categorie. Je UI rendert direct
        vanuit deze data (data‑driven), geen aparte hardcoded renders nodig.
    */
    const GEAR_CATALOG = {
      pistol:   { key:'pistol',   label:'🔫 Pistool (+10%, 3 uses)', bonus:0.10, uses:3, price:16 }, // prijs 18 → 16 (balans)
      lockpick: { key:'lockpick', label:'🗝️ Lockpick-set (+6%, 5 uses)', bonus:0.06, uses:5, price:12 },
      shovel:   { key:'shovel',   label:'⛏️ Schep (+4%, 8 uses)', bonus:0.04, uses:8, price:14 },  // prijs 10 → 14 (balans)
    };

    const ACTIONS = {
      overvallen: [
        {key:'visboer',      type:'heist', name:'Jat vis bij de visboer', emoji:'🐟', base:0.38, cost:10, payout:[4,9],  rep:2, heatS:6,  heatF:8,  hpF:1, arrest:0.18, minutes:1,  allowGear:true},
        {key:'keukenkast',   type:'heist', name:'Inbreken in keukenkast', emoji:'🍽️', base:0.30, cost:12, payout:[6,13], rep:3, heatS:8,  heatF:10, hpF:1, arrest:0.26, minutes:2,  allowGear:true},
        {key:'magazijn',     type:'heist', name:'Supermarkt-magazijn',    emoji:'📦', base:0.22, cost:16, payout:[10,18],rep:4, heatS:10, heatF:12, hpF:1, arrest:0.34, minutes:5,  allowGear:true},
        {key:'melkfabriek',  type:'heist', name:'Overval op melkfabriek', emoji:'🥛', base:0.18, cost:20, payout:[14,26],rep:5, heatS:12, heatF:16, hpF:1, arrest:0.42, minutes:7,  allowGear:true},
        {key:'dierenwinkel', type:'heist', name:'Dierenwinkel-raid',      emoji:'🐾', base:0.14, cost:22, payout:[20,34],rep:7, heatS:14, heatF:20, hpF:2, arrest:0.55, minutes:10, allowGear:true}
      ],
      misdaden: [
        {key:'zakkenrollen', type:'crime', name:'Zakkenrollen op de markt', emoji:'👜', base:0.25, cost:8,  payout:[2,6],  rep:1, heatS:4, heatF:7,  hpF:1, arrest:0.22, minutes:2, allowGear:true},
        {key:'autokraak',    type:'crime', name:'Autokraak bij parkeerplaats', emoji:'🚗', base:0.20, cost:14, payout:[8,16], rep:3, heatS:8, heatF:12, hpF:1, arrest:0.38, minutes:5, allowGear:true},
        {key:'graffiti',     type:'crime', name:'Graffiti op het hondenhok', emoji:'🎨', base:0.30, cost:6,  payout:[1,4],  rep:1, heatS:3, heatF:6,  hpF:0, arrest:0.18, minutes:1, allowGear:false}
      ],
      werk: [
        {key:'knuffel',   type:'work', name:'Poseren als knuffel',          emoji:'🧸', cost:8,  payout:[3,7],  rep:1},
        {key:'ratten',    type:'work', name:'Ratten vangen in de haven',    emoji:'🐭', cost:10, payout:[5,10], rep:2},
        {key:'chauffeur', type:'work', name:'Dozen-mobiel chauffeur',       emoji:'🚚', cost:12, payout:[7,12], rep:2}
      ],
      shop: ['pistol','lockpick','shovel']
    };

    /* ------------------------------------------------------------
       RANDOM & MATH HELPERS
       - rng(): lineaire congruentie generator → snel & deterministisch.
       - clamp(): knipt waarden naar [min,max].
       - pct(): decimaal 0..1 → 0..100 integer.
       - now(): wrapper voor Date.now() (leesbaarheid).
    ------------------------------------------------------------ */
    function rng(){ state.seed=(state.seed*1664525+1013904223)>>>0; return (state.seed>>>0)/4294967296; }
    const clamp=(n,min=0,max=100)=>Math.max(min,Math.min(max,n));
    const pct=(x)=> Math.round(x*100);
    const now = ()=> Date.now();

    /* ------------------------------------------------------------
       SAVE / LOAD / RESET
       - Slaat volledige state op in localStorage.
       - reset(): zet state terug naar defaults (en forceert UI‑refresh).
    ------------------------------------------------------------ */
    function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); toast('💾 Opgeslagen'); }
    function load(){ try{ const raw=localStorage.getItem(SAVE_KEY); return raw?JSON.parse(raw):null }catch{return null} }
    function reset(){ localStorage.removeItem(SAVE_KEY); Object.assign(state,{name:'',cash:10,hp:9,en:100,rep:0,heat:0,day:1,xp:{},gear:{bag:[],equipped:[]},seed:Math.floor(Math.random()*1e9),asielUntil:0}); update(); showView('log'); log('🔄 Reset voltooid.'); }

    /* ------------------------------------------------------------
       RANGBEPALING
       - Eenvoudige tabel op basis van totale reputatie (rep).
       - We lopen oplopend door de drempels en pakken de hoogste die past.
    ------------------------------------------------------------ */
    function rank(){ const R=[{n:'Kittenspion',r:0},{n:'Straatkat',r:30},{n:'Klapkat',r:80},{n:'Miauwster',r:150},{n:'Katerbaas',r:250},{n:'Oude wijze poes',r:400},{n:'Don Purrino',r:700}]; let cur=R[0].n; for(const rr of R){ if(state.rep>=rr.r) cur=rr.n; else break;} return cur; }

    /* ------------------------------------------------------------
       KATTENASIEL (tijdstraf)
       - Bij 100% alert of bij pech op misdaad/overval kom je hier terecht.
       - asielUntil is een timestamp in ms; UI toont een countdown.
    ------------------------------------------------------------ */
    function isInAsiel(){ return state.asielUntil && now() < state.asielUntil; }
    function remainingAsielMs(){ return Math.max(0, state.asielUntil - now()); }
    function setAsiel(minutes, reason='Opgepakt'){
      const addMs = minutes*60*1000;
      state.asielUntil = Math.max(state.asielUntil || 0, now() + addMs); // stapelt indien al vastzit
      showView('asiel');
      renderAsiel();
      // Politiekat stempel-animatie trigger
      const overlay = document.getElementById('stampOverlay');
      const img = document.getElementById('stampImage');
      if (overlay && img) {
        overlay.classList.remove('hidden');
        img.classList.remove('stamp-anim'); // reset
        void img.offsetWidth;               // reflow for restart
        img.classList.add('stamp-anim');
        setTimeout(()=> overlay.classList.add('hidden'), 900);
      }
      showResult(`⛓️ ${reason}: Kattenasiel voor ${minutes} min.`, 'err');
      log(`⛓️ ${reason}: Kattenasiel (${minutes} min).`);
    }
    function freeFromAsiel(){
      state.asielUntil = 0; state.heat = 0; // alert reset bij vrijlating
      showResult('✅ Je bent vrij uit het Kattenasiel! Alert is teruggezet naar 0%.','ok');
      log('✅ Vrij uit Kattenasiel.'); updateHUD(); showView('log');
    }
    let asielTimer=null;
    function renderAsiel(){
      const status = $('#asielStatus'), cd = $('#asielCountdown');
      if(isInAsiel()){ status.textContent = 'Je zit vast in het Kattenasiel. Wacht tot je vrijgelaten wordt.'; tickAsiel(); }
      else { status.textContent = 'Je bent vrij. Blijf uit de problemen… of niet 😼'; cd.textContent = '--:--:--'; if(asielTimer){ clearInterval(asielTimer); asielTimer=null; } }
    }
    function fmt(ms){ const s=Math.ceil(ms/1000); const hh=Math.floor(s/3600).toString().padStart(2,'0'); const mm=Math.floor((s%3600)/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return `${hh}:${mm}:${ss}`; }
    function tickAsiel(){
      if(asielTimer){ clearInterval(asielTimer); }
      asielTimer = setInterval(()=>{
        if(!isInAsiel()){ clearInterval(asielTimer); asielTimer=null; freeFromAsiel(); return; }
        $('#asielCountdown').textContent = fmt(remainingAsielMs());
      }, 1000);
      $('#asielCountdown').textContent = fmt(remainingAsielMs());
    }

    /* ------------------------------------------------------------
       VIEW SWITCHER & RESULTAAT‑BANNER
       - showView(): verbergt alle center‑views en toont er één.
       - showResult(): compact bericht dat na 2.5s automatisch sluit.
    ------------------------------------------------------------ */
    function showView(kind){
      ['logView','listView','shopView','invView','asielView','infoView'].forEach(id=>$('#'+id).classList.add('hidden'));
      $('#centerResult').classList.add('hidden');
      if(kind==='log'){ $('#centerTitle').textContent='Stad & Logboek'; $('#logView').classList.remove('hidden'); }
      if(kind==='list'){ $('#centerTitle').textContent=$('#listIntro').dataset.title||'Acties'; $('#listView').classList.remove('hidden'); }
      if(kind==='shop'){ $('#centerTitle').textContent='Kattenshop'; $('#shopView').classList.remove('hidden'); renderShop(); }
      if(kind==='inv'){ $('#centerTitle').textContent='Inventaris'; $('#invView').classList.remove('hidden'); renderInv(); }
      if(kind==='asiel'){ $('#centerTitle').textContent='Kattenasiel'; $('#asielView').classList.remove('hidden'); renderAsiel(); }
      if(kind==='info'){ $('#centerTitle').textContent='Info'; $('#infoView').classList.remove('hidden'); }
    }

    let resultTimer=null;
    function showResult(msg, type='info'){
      const el=$('#centerResult');
      el.textContent=msg; el.classList.remove('hidden');
      // Reset alle kleurenklassen en bouw opnieuw op
      el.className='mb-3 p-3 rounded-xl border text-sm';
      if(type==='ok'){ el.classList.add('bg-green-50','border-green-200','text-green-800'); }
      else if(type==='err'){ el.classList.add('bg-red-50','border-red-200','text-red-800'); }
      else{ el.classList.add('bg-pink-50','border-pink-200','text-pink-900'); }
      clearTimeout(resultTimer);
      resultTimer=setTimeout(()=>{ el.classList.add('hidden'); }, 2500);
    }

    /* ------------------------------------------------------------
       HUD & ECONOMIE HELPERFUNCTIES
       - updateHUD(): synchroniseert alle HUD‑elementen met state.
       - spend(): energiecheck + subtract; blokkeert acties in asiel.
       - addCash/HP/Rep/Heat: centrale mutators met safety.
    ------------------------------------------------------------ */
    function updateHUD(){
      $('#cash').textContent=state.cash; $('#hp').textContent=state.hp; $('#en').textContent=state.en+'%'; $('#heat').textContent=state.heat+'%'; $('#rep').textContent=state.rep;
      $('#day').textContent=state.day; $('#rank').textContent=rank();
      $('#enBar').style.width=clamp(state.en)+'%'; $('#heatBar').style.width=clamp(state.heat)+'%';
      // HUD rechtsboven (compact)
      $('#hudCash').textContent=state.cash; $('#hudHP').textContent=state.hp; $('#hudEN').textContent=state.en+'%'; $('#hudHeat').textContent=state.heat+'%'; $('#hudRep').textContent=state.rep;
      $('#charName').value=state.name||'';
      renderActiveGearBadges();
    }
    function update(){ updateHUD(); if(isInAsiel()) { showView('asiel'); } }
    function spend(c){ if(isInAsiel()){ showView('asiel'); showResult('Je zit in het Kattenasiel. Acties zijn geblokkeerd.','err'); return false; } if(state.en<c){ showResult('😴 Te moe om te miauwen.','err'); return false;} state.en=clamp(state.en-c); return true; }
    function addCash(c){ state.cash=Math.max(0,state.cash+c); }
    function addHP(h){ state.hp=Math.max(0,state.hp+h); }
    function addRep(r){ state.rep=Math.max(0,state.rep+r); }
    function addHeat(h){ state.heat=clamp(state.heat+h); if(state.heat>=100){ setAsiel(15,'100% Alert'); } }

    /* ------------------------------------------------------------
       GEAR / UITRUSTING
       - totalGearBonus(): som van bonussen van alle equipped items.
       - consumeGearUse(): slijt 1 use op alle equipped items na misdaad/overval.
         * Tricky deel: we verwijderen versleten items uit de bag en moeten
           vervolgens de indices in "equipped" her‑mappen naar het nieuwe bag‑array.
       - renderActiveGearBadges(): toont kleine labels met uses over in HUD.
    ------------------------------------------------------------ */
    function totalGearBonus(){ let sum=0; state.gear.equipped.forEach(idx=>{ const inst=state.gear.bag[idx]; if(inst){ const meta=GEAR_CATALOG[inst.k]; if(meta) sum+=meta.bonus; } }); return sum; }
    function renderActiveGearBadges(){ const cont=$('#activeGearBadges'); const hud=$('#gearHUD'); const parts=[]; state.gear.equipped.forEach(idx=>{ const inst=state.gear.bag[idx]; if(inst){ const meta=GEAR_CATALOG[inst.k]; parts.push(`<span class="pill">${meta.label.split('(')[0].trim()} · ${inst.usesLeft}u</span>`); } }); const html=parts.join(' '); if(cont){ cont.innerHTML= html || '<span class="text-black/50">—</span>'; } if(hud){ hud.classList.toggle('hidden', parts.length===0); hud.innerHTML= html; } }
    function wearGear(idx){ if(state.gear.equipped.length>=2){ showResult('Je kunt maximaal 2 items tegelijk dragen.','err'); return; } if(!state.gear.equipped.includes(idx)){ state.gear.equipped.push(idx); updateHUD(); renderInv(); } }
    function unwearGear(idx){ const i=state.gear.equipped.indexOf(idx); if(i>=0){ state.gear.equipped.splice(i,1); updateHUD(); renderInv(); } }
    function consumeGearUse(){
      const toRemove=[];
      // Slijt 1 use op alle equipped items
      state.gear.equipped.forEach(idx=>{ const inst=state.gear.bag[idx]; if(inst){ inst.usesLeft=Math.max(0,(inst.usesLeft||0)-1); if(inst.usesLeft<=0) toRemove.push(idx); } });
      if(toRemove.length){
        // Log welke items stuk gingen
        toRemove.forEach(idx=>{ const meta=GEAR_CATALOG[state.gear.bag[idx]?.k]; log(`🧰 ${meta?meta.label:'Item'} versleten (0 uses).`); });
        // We bouwen de bag opnieuw zonder de versleten items, en mappen de indices om
        const old=state.gear.bag; state.gear.bag=[]; const remap=new Map();
        old.forEach((inst,i)=>{ if(inst && !toRemove.includes(i)){ remap.set(i, state.gear.bag.length); state.gear.bag.push(inst); } });
        state.gear.equipped = state.gear.equipped
          .map(oldIdx=> remap.has(oldIdx)? remap.get(oldIdx): -1)
          .filter(x=>x>=0);
      }
      updateHUD(); renderInv();
    }

    /* ------------------------------------------------------------
       XP & KANSEN (balanspatch)
       - xpBoost(): afnemende meeropbrengst via sqrt; max +30%.
       - actionChance(): basis + xpBoost + (optioneel) gear; capped op 95%.
       - arrestChanceOnFail(): basisarrest + milde extra kans bij lage succes‑kans.
    ------------------------------------------------------------ */
    function xpOf(key){ return state.xp[key]||0; }
    function addXP(key, amt){ state.xp[key]=(state.xp[key]||0)+amt; }
    function xpBoost(xp){ return Math.min(0.30, Math.sqrt(xp)/50); } // b.v. 25 XP ≈ +10%, 100 XP ≈ +20%, cap 30%

    function actionChance(act){
      const xp = xpOf(act.key);
      let chance = (act.base||0) + xpBoost(xp);
      if(act.allowGear){ chance += totalGearBonus(); }
      return Math.min(chance, 0.95);
    }
    function arrestChanceOnFail(act, successChance){ if(!act.arrest) return 0; const extra=(1-successChance)*0.35; return Math.min(1, (act.arrest||0) + extra); }

    /* ------------------------------------------------------------
       ACTIE‑ENGINE (één pad voor heist/crime/werk)
       - doAction(): voert de kansberekening uit en verwerkt succes/falen.
       - Bij succes: geld, rep, alert succeswaarde, +3 XP.
       - Bij falen: HP‑schade, alert faalwaarde, +1 XP, optioneel asiel.
       - Na misdaad/overval: gear slijt 1 use op alle equipped items.
    ------------------------------------------------------------ */
    function doAction(act){
      if(!spend(act.cost||0)) return;       // energiecheck + early exit
      const chance = actionChance(act);      // 0..0.95
      const roll = rng();                    // 0..1
      if(roll < chance){
        const min=act.payout?act.payout[0]:0, max=act.payout?act.payout[1]:0; const gain=min + Math.floor(rng()*(max-min+1));
        addCash(gain); addRep(act.rep||0); addHeat(act.heatS||0); addXP(act.key, 3);
        showResult(`✅ Succes: ${act.name}. ${gain?`+${gain} blikvoer, `:''}+${act.rep||0} purr, +alert.`,'ok');
        log(`✅ ${act.emoji||''} Succes: ${act.name}. ${gain?`+${gain} blikvoer, `:''}+${act.rep||0} purr, +alert.`);
      } else {
        addHP(-(act.hpF||0)); addHeat(act.heatF||0); addXP(act.key, 1);
        if(act.minutes && (rng() < arrestChanceOnFail(act, chance))){
          setAsiel(act.minutes, 'Opgepakt bij mislukte actie');
          log(`⛓️ Arrest: ${act.minutes} min asiel.`); showView('asiel');
        } else {
          showResult(`❌ Mislukt: ${act.name}. ${act.hpF?`−${act.hpF} leven, `:''}+alert.`,'err');
        }
        log(`❌ ${act.emoji||''} Mislukt: ${act.name}.${isInAsiel()?' (Opgepakt)':''}`);
      }
      if(act.type==='heist' || act.type==='crime') consumeGearUse();
      updateHUD();
    }

    /* ------------------------------------------------------------
       RENDERERS
       - renderList(kind): één generieke lijst voor overvallen/misdaden/werk.
         * Toont kans, gearbonus, arrestkans, XP‑balk en actieknop.
       - Shop/Inv hebben eigen renderfuncties.
    ------------------------------------------------------------ */
    function renderList(kind){
      const list = ACTIONS[kind]; const ul=$('#listUL'); ul.innerHTML='';
      const intro=$('#listIntro'); intro.dataset.title = kind==='overvallen'?'Overvallen': kind==='misdaden'?'Misdaden':'Werk';
      intro.innerHTML = kind==='werk'
        ? 'Verdien blikvoer en een beetje purr door klusjes te doen. <b>Werk verhoogt geen Alert.</b>'
        : 'Begin bovenaan bij de makkelijke doelen. Elke poging geeft <b>XP</b> — meer XP = hogere <b>slagingskans</b>.';

      list.forEach(act=>{
        const xp = xpOf(act.key);
        const ch = act.type==='work' ? null : actionChance(act);
        const aCh = act.type==='work' ? null : arrestChanceOnFail(act, ch);
        const gear = act.allowGear ? Math.round(totalGearBonus()*100) : 0;
        const xpPct = Math.min(100, Math.floor((xp/25)*100)); // simpele UI‑schaal voor XP‑balk
        const li=document.createElement('li'); li.className='flex items-center gap-3 bg-white rounded-xl px-3 py-2 border border-pink-100';
        li.innerHTML = `
          <div class="text-xl">${act.emoji||'🐾'}</div>
          <div class="grow min-w-0">
            <div class="flex items-center justify-between gap-2">
              <p class="font-semibold truncate">${act.name}</p>
              <span class="text-xs">${act.type==='work' ? `Energie ${act.cost}` : `Kans: <b>${pct(ch)}%</b> ${gear?`<span class=\"opacity-60\">(+${gear}% gear)</span>`:''}`}</span>
            </div>
            <p class="text-xs text-black/60">${act.type==='work'
              ? `Beloning ${act.payout[0]}–${act.payout[1]} · Purr +${act.rep} · <span class=\"pill\">Geen Alert</span>`
              : `Energie ${act.cost} · Buit ${act.payout[0]}–${act.payout[1]} · Purr +${act.rep}`}
            </p>
            ${act.type==='work' ? '' : `<p class=\"text-xs text-black/60\">Arrest bij falen: <b>${pct(aCh)}%</b> · Straf: <b>${act.minutes} min</b></p>`}
            <div class="xbar mt-1"><i style="width:${xpPct}%"></i></div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn px-3 py-1.5 rounded-lg ${act.type==='work'?'bg-black/5 hover:bg-black/10':'bg-[var(--accent)] hover:bg-[var(--accent-600)] text-white'} whitespace-nowrap" data-act="${act.key}">${act.type==='work'?'Aan de slag':'Doe actie'}</button>
          </div>
        `;
        ul.appendChild(li);
      });

      // Eén event‑pad dat de juiste actie uit alle categorieën zoekt en uitvoert
      $$('[data-act]', ul).forEach(b=> b.addEventListener('click', ()=> withLock(()=> {
        const key=b.getAttribute('data-act');
        const act = [...ACTIONS.overvallen, ...ACTIONS.misdaden, ...ACTIONS.werk].find(a=>a.key===key);
        if(!act) return;
        if(act.type==='work'){
          // Werk is altijd veilig: forceer succespad zonder alert/gear
          const w = {...act, base:1, arrest:0, minutes:0, heatS:0, heatF:0, allowGear:false};
          doAction(w);
        } else {
          doAction(act);
        }
      })));

      // Als je vastzit, blokkeer knoppen voor duidelijkheid
      if(isInAsiel()) $$('[data-act]', ul).forEach(b=>{ b.disabled=true; b.classList.add('opacity-60','cursor-not-allowed'); });

      showView('list');
    }

    // SHOP: eenvoudige renderer; koopknoppen trekken uit GEAR_CATALOG
    function renderShop(){
      const ul=$('#shopListCenter'); ul.innerHTML='';
      ACTIONS.shop.forEach(k=>{
        const meta=GEAR_CATALOG[k];
        const li=document.createElement('li'); li.className='relative flex items-center justify-between bg-white rounded-xl px-3 py-2 border border-pink-100';
        li.innerHTML=`<span>${meta.label}</span><div class=\"flex items-center gap-2\"><span class=\"text-xs text-black/60\">Prijs ${meta.price}</span><button data-buy=\"${meta.key}\" class=\"btn px-3 py-1.5 rounded-lg bg-black/5 hover:bg-black/10\">Koop</button></div>`;
        ul.appendChild(li);
      });
      $$('[data-buy]', ul).forEach(b=> b.addEventListener('click', ()=> withLock(()=> buyGear(b.getAttribute('data-buy')))));
    }

    // Kopen van gear met checks (asiel / geld / validatie)
    function buyGear(key){
      if(isInAsiel()){ showView('asiel'); showResult('Je zit in het Kattenasiel. Kopen is nu niet mogelijk.','err'); return; }
      const meta=GEAR_CATALOG[key]; if(!meta){ showResult('Onbekend item.','err'); return; }
      const price=meta.price; if(state.cash<price){ showResult('Niet genoeg blikvoer.','err'); return; }
      addCash(-price);
      state.gear.bag.push({k:key, usesLeft: meta.uses});
      showResult(`🛍️ Gekocht: ${meta.label}.`, 'ok');
      log(`🛍️ Gekocht: ${meta.label}.`);
      updateHUD(); renderShop(); if(!$('#invView').classList.contains('hidden')) renderInv();
    }

    // INVENTARIS: equip/unequip‑knoppen renderen per iteminstantie
    function renderInv(){
      const ul=$('#invListCenter'); ul.innerHTML='';
      state.gear.bag.forEach((inst,idx)=>{
        if(!inst) return;
        const meta=GEAR_CATALOG[inst.k];
        const equipped=state.gear.equipped.includes(idx);
        const uses=Math.max(0, inst.usesLeft||0);
        const li=document.createElement('li'); li.className='flex items-center justify-between bg-white rounded-xl px-3 py-2 border border-pink-100';
        li.innerHTML=`<div class=\"min-w-0\"><p class=\"font-medium truncate\">${meta.label.split('(')[0].trim()}</p><p class=\"text-xs text-black/60\">${pct(meta.bonus)}% kans · ${uses} uses</p></div><div class=\"flex items-center gap-2\">${equipped?`<button data-unwear=\"${idx}\" class=\"btn px-3 py-1.5 rounded-lg bg-pink-100 hover:bg-pink-200\">Afdoen</button>`:`<button data-wear=\"${idx}\" class=\"btn px-3 py-1.5 rounded-lg bg-black/5 hover:bg-black/10\"${state.gear.equipped.length>=2?' disabled':''}>Uitrusten</button>`}</div>`;
        ul.appendChild(li);
      });
      $$('[data-wear]', ul).forEach(b=> b.addEventListener('click', ()=> withLock(()=> wearGear(parseInt(b.getAttribute('data-wear'),10)))));
      $$('[data-unwear]', ul).forEach(b=> b.addEventListener('click', ()=> withLock(()=> unwearGear(parseInt(b.getAttribute('data-unwear'),10)))));
      renderActiveGearBadges();
    }

    /* ------------------------------------------------------------
       DIVERSE UTILITIES
       - log(): nieuwe regels komen bovenaan (prepend) in het logboek.
       - toast(): klein tijdelijk bericht onderin het scherm.
       - rest()/nextDay(): simpele dagcyclus; nextDay geneest 1 HP (cap 9).
    ------------------------------------------------------------ */
    function log(t){ const d=document.createElement('div'); d.className='bg-white border border-pink-200/60 rounded px-3 py-2'; d.textContent=t; $('#log').prepend(d); }
    function toast(msg){ const t=document.createElement('div'); t.className='fixed bottom-4 left-1/2 -translate-x-1/2 bg-black/80 text-white px-3 py-2 rounded-xl text-sm'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1400); }
    function rest(){ if(isInAsiel()){ showView('asiel'); showResult('Je zit in het Kattenasiel. Rusten heeft nu geen effect.','err'); return; } state.en=clamp(state.en+12); state.heat=clamp(state.heat-3); showResult('🛌 Even rust: +12 energie, −3 alert.'); log('🛌 Rust genomen.'); updateHUD(); }
    function nextDay(){
      state.day++;
      if(!isInAsiel()){
        state.en=clamp(state.en+25);
        state.heat=clamp(state.heat-5);
        state.hp = Math.min(9, state.hp + 1); // zacht herstel om softlocks te voorkomen
      }
      // Kleine random daggebeurtenis (geeft afwisseling zonder grote impact)
      const r=rng();
      if(!isInAsiel()){
        if(r<.15){ const fine=2+Math.floor(rng()*6); addCash(-fine); addHeat(3); log(`🐕 Boete: −${fine} blikvoer (+alert)`);}
        else if(r<.28){ const find=2+Math.floor(rng()*6); addCash(find); log(`🎁 Je vond ${find} blikvoer in een doos.`);} 
        else if(r<.34){ addHP(-1); log('🛁 Je viel in de badkuip. −1 leven.'); }
      } else {
        log('⛓️ Je zit nog in het Kattenasiel…');
      }
      update();
    }

    /* ------------------------------------------------------------
       EVENT BINDINGS
       - Alle UI‑knoppen koppelen aan render/engine functies.
    ------------------------------------------------------------ */
    $('#openHeists').addEventListener('click', ()=> renderList('overvallen'));
    $('#openCrimes').addEventListener('click', ()=> renderList('misdaden'));
    $('#openWork').addEventListener('click',  ()=> renderList('werk'));
    $('#openShop').addEventListener('click',  ()=> showView('shop'));
    $('#openInv').addEventListener('click',   ()=> showView('inv'));
    $('#openAsiel').addEventListener('click', ()=> showView('asiel'));
    $('#openInfo').addEventListener('click',  ()=> showView('info'));
    $$('[data-nav="log"]').forEach(b=> b.addEventListener('click', ()=> showView('log')));

    $('#nextDay').addEventListener('click', ()=> withLock(nextDay));
    $('#restBtn').addEventListener('click', ()=> withLock(rest));
    $('#saveBtn').addEventListener('click', save);
    $('#resetBtn').addEventListener('click', reset);
    $('#charName').addEventListener('input',e=>{ state.name=e.target.value; });

    // Init: eerste render + welkomsregel (alleen op koude start)
    function initialRender(){
      update(); showView('log');
      if(!load()) log('Welkom! Data‑driven acties + balanspatch actief. 🐾');
      if(isInAsiel()) tickAsiel();
    }
    initialRender();
  </script>
<!-- Politiekat stempel overlay -->
<div id="stampOverlay" class="fixed inset-0 flex items-center justify-center pointer-events-none hidden z-50">
  <!-- was: class="w-1/2 max-w-xs" -->
  <img id="stampImage" src="assets/politiekat.png" alt="Politiekat"
       class="w-[70vw] max-w-[720px]">
</div>
  </div>
</body>
</html>
